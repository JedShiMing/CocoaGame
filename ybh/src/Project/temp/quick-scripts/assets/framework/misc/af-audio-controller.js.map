{"version":3,"sources":["af-audio-controller.js"],"names":["EventDispatcher","require","Event","JS","cc","js","AudioMgr","init","sounds","musicPlayer","bgmAudioID","qqSounds","nextBGM","currentBGM","on","GMAE_ON_HIDE","onGameEnterBackground","GAME_ON_SHOW","onGameEnterForeground","GAME_ON_BGM","onGameBGM","playEffect","name","AF","platform","isWxApp","wxPlayEffect","isQQApp","qqPlayEffect","audioEngine","play","util","getSoundUrl","list","length","stop","destroy","splice","wxAudioContext","wx","createInnerAudioContext","src","push","isSoundExist","url","obj","i","id","context","BK","createAudioContext","complete","result","wxPlayMusic","getMusicUrl","loop","volume","qqPlayMusic","playBGM","stopBGM","pauseBGM","pause","resumeBGM","resume","state","getState","audio","playDefaultBGM","playButtonEffect","auidoName","playDialogPopOutEffect","module","exports","window"],"mappings":"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","file":"af-audio-controller.js","sourceRoot":"../../../../../assets/framework/misc","sourcesContent":["/**\r\n * 音频控制器\r\n */\r\n\r\nvar EventDispatcher = require(\"af-event-dispatcher\");\r\nvar Event = require(\"af-event\");\r\n\r\nvar JS = cc.js;\r\n\r\nvar AudioMgr = {};\r\n\r\nAudioMgr.init = function () {\r\n\r\n    this.sounds = {};\r\n\r\n    this.musicPlayer = null;\r\n\r\n    this.bgmAudioID = -1;\r\n\r\n    this.qqSounds = {};\r\n\r\n    this.nextBGM = \"\";\r\n    this.currentBGM = \"\";\r\n    // 监听游戏切换到前后台\r\n    EventDispatcher.on(Event.GMAE_ON_HIDE, this.onGameEnterBackground, this);\r\n    EventDispatcher.on(Event.GAME_ON_SHOW, this.onGameEnterForeground, this);\r\n    EventDispatcher.on(Event.GAME_ON_BGM, this.onGameBGM, this);\r\n};\r\n\r\nAudioMgr.playEffect = function (name) {\r\n    if (AF.platform.isWxApp()) {\r\n        this.wxPlayEffect(name);\r\n    } else if (AF.platform.isQQApp()) {\r\n        this.qqPlayEffect(name);\r\n    } else {\r\n        cc.audioEngine.play(AF.util.getSoundUrl(name), false, 1);\r\n    }\r\n};\r\n\r\nAudioMgr.wxPlayEffect = function (name) {\r\n    var list = this.sounds[name];\r\n\r\n    if (!list) {\r\n        list = [];\r\n        this.sounds[name] = list;\r\n    }\r\n\r\n    if (list.length >= 16) {\r\n        list[0].stop();\r\n        list[0].destroy();\r\n        list.splice(0, 1);\r\n    }\r\n\r\n    var wxAudioContext = wx.createInnerAudioContext();\r\n    wxAudioContext.src = AF.util.getSoundUrl(name);\r\n    wxAudioContext.play();\r\n\r\n    list.push(wxAudioContext);\r\n\r\n    // console.log(\"new: \", list.length);\r\n};\r\n\r\nAudioMgr.qqPlayEffect = function (name) {\r\n\r\n    if (!AF.util.isSoundExist(name)) {\r\n        return;\r\n    }\r\n\r\n    var url =  AF.util.getSoundUrl(name);\r\n\r\n    var list = this.qqSounds[name];\r\n\r\n    if (!list) {\r\n        list = [];\r\n        this.qqSounds[name] = list;\r\n    }\r\n\r\n    var obj = null;\r\n\r\n    for (let i = 0; i < list.length; i++) {\r\n        if (list[i].id == 0) {\r\n            obj = list[i];\r\n            break;\r\n        }\r\n    }\r\n\r\n    if (!obj) {\r\n        if (list.length >= 32) {\r\n            return;\r\n        }\r\n\r\n        var context = BK.createAudioContext({'type':'effect','src':url});\r\n\r\n        obj = {\r\n            context: context,\r\n            id: 0\r\n        }\r\n\r\n        list.push(obj);\r\n    }\r\n\r\n    obj.id = -1;\r\n\r\n    obj.context.play({complete:function(result){\r\n        obj.id = 0;\r\n    }});\r\n};\r\n\r\n// 播放音效\r\nAudioMgr.play = function (name) {\r\n    this.playEffect(name);\r\n};\r\n\r\nAudioMgr.wxPlayMusic = function () {\r\n    if (this.musicPlayer) {\r\n        this.musicPlayer.stop();\r\n        this.musicPlayer.destroy();\r\n        this.musicPlayer = null;\r\n    }\r\n\r\n    this.musicPlayer = wx.createInnerAudioContext();\r\n\r\n    this.musicPlayer.src = AF.util.getMusicUrl(this.nextBGM);\r\n    this.musicPlayer.loop = true;\r\n    this.musicPlayer.volume = 1;\r\n    this.musicPlayer.play();\r\n\r\n    this.currentBGM = this.nextBGM;\r\n    this.nextBGM = \"\";\r\n};\r\n\r\nAudioMgr.qqPlayMusic = function () {\r\n    /*\r\n    if (this.musicPlayer) {\r\n        this.musicPlayer.stop();\r\n        this.musicPlayer.destroy();\r\n        this.musicPlayer = null;\r\n    }\r\n\r\n    this.musicPlayer = wx.createInnerAudioContext();\r\n\r\n    this.musicPlayer.src = AF.util.getMusicUrl(this.nextBGM);\r\n    this.musicPlayer.loop = true;\r\n    this.musicPlayer.volume = 1;\r\n    this.musicPlayer.play();\r\n\r\n    this.currentBGM = this.nextBGM;\r\n    this.nextBGM = \"\";\r\n    */\r\n};\r\n\r\n// 设置背景音乐\r\nAudioMgr.playBGM = function (name) {\r\n    this.nextBGM = name;\r\n};\r\n\r\nAudioMgr.stopBGM = function () {\r\n    if (AF.platform.isWxApp()) {\r\n        if (this.musicPlayer) {\r\n            this.musicPlayer.stop();\r\n            this.musicPlayer.destroy();\r\n            this.musicPlayer = null;\r\n        }\r\n        return;\r\n    }\r\n\r\n    if (this.bgmAudioID != -1) {\r\n        cc.audioEngine.stop(this.bgmAudioID);\r\n        this.bgmAudioID = -1;\r\n    }\r\n};\r\n\r\nAudioMgr.pauseBGM = function () {\r\n    if (AF.platform.isWxApp()) {\r\n        if (this.musicPlayer) {\r\n            this.musicPlayer.pause();\r\n        }\r\n        return;\r\n    }\r\n\r\n    if (this.bgmAudioID != -1) {\r\n        cc.audioEngine.pause(this.bgmAudioID);\r\n    }\r\n};\r\n\r\nAudioMgr.resumeBGM = function () {\r\n    if (AF.platform.isWxApp()) {\r\n        if (this.musicPlayer) {\r\n            this.musicPlayer.play();\r\n        }\r\n        return;\r\n    }\r\n\r\n    if (this.bgmAudioID != -1) {\r\n        cc.audioEngine.resume(this.bgmAudioID);\r\n    }\r\n};\r\n\r\nAudioMgr.onGameBGM = function () {\r\n\r\n    if (this.nextBGM == \"\") {\r\n        return;\r\n    }\r\n\r\n    if (AF.platform.isWxApp()) {\r\n        this.wxPlayMusic();\r\n    //} else if (AF.platform.isQQApp()) {\r\n    //    this.qqPlayMusic();\r\n    } else {\r\n        if (this.bgmAudioID != -1) {\r\n            var state = cc.audioEngine.getState(this.bgmAudioID);\r\n            //console.log(\"state = \", state);\r\n            if (state == 0) {\r\n                return;\r\n            } else if (state == 1) {\r\n                cc.audioEngine.stop(this.bgmAudioID);\r\n            } else if (state == 2) {\r\n                cc.audioEngine.resume(this.bgmAudioID);\r\n                return;\r\n            } else {\r\n                this.bgmAudioID = -1;\r\n            }\r\n        }\r\n\r\n        if (this.bgmAudioID != -1) {\r\n            return;\r\n        }\r\n\r\n        var audio = AF.util.getMusicUrl(this.nextBGM);\r\n        this.bgmAudioID = cc.audioEngine.play(audio, true, 1);\r\n        this.currentBGM = this.nextBGM;\r\n        this.nextBGM = \"\";\r\n    }\r\n};\r\n\r\nAudioMgr.playDefaultBGM = function () {\r\n    this.playBGM(\"bgm\");\r\n};\r\n\r\nAudioMgr.playButtonEffect = function (name) {\r\n    var auidoName = name || \"button\";\r\n    this.play(auidoName);\r\n};\r\n\r\nAudioMgr.playDialogPopOutEffect = function () {\r\n\r\n};\r\n\r\nAudioMgr.onGameEnterBackground = function () {\r\n    AF.audio.pauseBGM();\r\n\r\n    // if (AF.platform.isWxApp()) {\r\n    //     if (this.musicPlayer) {\r\n    //         this.musicPlayer.pause();\r\n    //     }\r\n    //     return;\r\n    // }\r\n\r\n    // if (this.bgmAudioID != -1) {\r\n    //     cc.audioEngine.pause(this.bgmAudioID);\r\n    // }\r\n};\r\n\r\nAudioMgr.onGameEnterForeground = function () {\r\n    AF.audio.resumeBGM();\r\n    // if (AF.platform.isWxApp()) {\r\n    //     if (this.musicPlayer) {\r\n    //         this.musicPlayer.play();\r\n    //     }\r\n    //     return;\r\n    // }\r\n\r\n    // if (this.bgmAudioID != -1) {\r\n    //     cc.audioEngine.resume(this.bgmAudioID);\r\n    // }\r\n};\r\n\r\nAudioMgr.init();\r\n\r\nmodule.exports = (window.AF = window.AF || {}).audio = AudioMgr;"]}