{"version":3,"sources":["AFMarqueeNotice.js"],"names":["Const","require","NoticeMgr","cc","Class","extends","Component","editor","menu","properties","msgPanel","default","type","Node","displayName","msgLabel","RichText","moveSpeed","range","onLoad","_queue","_showing","_setZIndex","registerMarqueeWidget","_setAllVisible","onDestroy","unregisterMarqueeWidget","show","msg","push","_showText","root","director","getScene","node","parent","zIndex","TOAST_MESSAGE_Z_ORDER","length","_onAllNoticeShowed","shift","string","x","winSize","width","scheduleOnce","_runMarqueeAnimation","bind","panelSize","getContentSize","sz","distance","duration","self","act","sequence","moveTo","v2","callFunc","runAction","visblie","active"],"mappings":"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","file":"AFMarqueeNotice.js","sourceRoot":"../../../../../../assets/framework/ui/widget","sourcesContent":["/**\r\n * 跑马灯消息\r\n */\r\nvar Const     = require(\"af-const\");\r\nvar NoticeMgr = require('af-notice-mgr');\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    editor: {\r\n        menu: 'ApplicationFramework/AFMarqueeNotice'\r\n    },\r\n\r\n    properties: {\r\n        msgPanel: {\r\n            default: null,\r\n            type: cc.Node,\r\n            displayName: \"消息底框\",\r\n        },\r\n        msgLabel: {\r\n            default: null,\r\n            type: cc.RichText,\r\n            displayName: \"消息文本标签\",\r\n        },\r\n\r\n        moveSpeed: {\r\n            default: 150,\r\n            displayName: \"移动速度\",\r\n            range: [100, 500]\r\n        },\r\n    },\r\n\r\n    // use this for initialization\r\n    onLoad: function () {\r\n        this._queue = [];\r\n        this._showing = false;\r\n\r\n        this._setZIndex();\r\n\r\n        NoticeMgr.registerMarqueeWidget(this);\r\n\r\n        this._setAllVisible(false);\r\n    },\r\n\r\n    onDestroy: function() {\r\n        NoticeMgr.unregisterMarqueeWidget();\r\n    },\r\n\r\n    show: function(msg) {\r\n        this._queue.push(msg);\r\n        this._showText();\r\n    },\r\n\r\n    _setZIndex: function() {\r\n        // 由于不能把节点放到Canvas的外部，但对话框是加在最上层的，所以需要放置在外面\r\n        var root = cc.director.getScene();\r\n        var node = this.node.parent;\r\n        node.parent = root;\r\n        node.zIndex = Const.TOAST_MESSAGE_Z_ORDER - 1;\r\n        // var node = this.node;\r\n        // while(true) {\r\n        //     if (node.parent == root) {\r\n        //         node.zIndex = Const.TOAST_MESSAGE_Z_ORDER - 1;\r\n        //         break;\r\n        //     } else {\r\n        //         node = node.parent;\r\n        //     }\r\n        // }\r\n    },\r\n\r\n    _showText: function() {\r\n        if (this._queue.length <= 0 || this._showing) {\r\n            if (this._queue.length == 0)\r\n                this._onAllNoticeShowed();\r\n            return;\r\n        };\r\n        this._setAllVisible(true);\r\n\r\n        this._showing = true;\r\n        var msg = this._queue.shift();\r\n        this.msgLabel.string = msg || \"\";\r\n        this.msgLabel.node.x = cc.winSize.width * 10;\r\n        this.scheduleOnce(this._runMarqueeAnimation.bind(this), 0);\r\n    },\r\n\r\n    _runMarqueeAnimation: function() {\r\n        var panelSize = this.msgPanel.getContentSize();\r\n        var sz = this.msgLabel.node.getContentSize();\r\n        var node = this.msgLabel.node;\r\n        node.x = panelSize.width * 0.5 + sz.width / 2;\r\n\r\n        var distance = sz.width + panelSize.width;\r\n        var duration = distance / this.moveSpeed;\r\n\r\n        var self = this;\r\n        var act = cc.sequence(\r\n            cc.moveTo(duration, cc.v2(-sz.width/2 - panelSize.width/2, 0)),\r\n            cc.callFunc(function(){\r\n                self._showing = false;\r\n                self._showText(); \r\n            })\r\n        );\r\n        node.runAction(act);\r\n    },\r\n\r\n    _setAllVisible: function(visblie) {\r\n        this.node.active = visblie;\r\n    },\r\n\r\n    _onAllNoticeShowed: function() {\r\n        this._setAllVisible(false);\r\n    },\r\n});\r\n"]}