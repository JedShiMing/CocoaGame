{"version":3,"sources":["../../../../../assets/framework/network/assets/framework/network/af-http.js"],"names":["http","encodeParams","obj","str","k","hasOwnProperty","undefined","length","encodeURIComponent","parseResponse","resp","JSON","parse","e","isValidParam","postDataFormat","FormData","data","attr","append","arr","v","push","join","getHttpStateHandle","xhr","cb","readyState","responseText","status","getFileHttpStateHandle","console","log","get","url","params","timeOut","callback","err","result","statusCode","handle","clearTimeout","setTimeout","abort","XMLHttpRequest","onreadystatechange","timeout","ontimeout","cc","open","send","getFile","responseType","post","body","stringify","setRequestHeader","module","exports","window","AF"],"mappings":"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","file":"af-http.js","sourceRoot":"../../../../../assets/framework/network","sourcesContent":["/**\r\n * http\r\n */\r\n\r\nvar http = {};\r\n\r\nfunction encodeParams(obj) {\r\n    if (!obj) return '';\r\n    var str = '';\r\n    for (var k in obj) {\r\n        if (obj.hasOwnProperty(k) && obj[k] !== undefined && obj[k] !== null ) {\r\n            str.length && (str += '&');\r\n            str += encodeURIComponent(k) + '=' + encodeURIComponent(obj[k]);\r\n        }\r\n    }\r\n    return str;\r\n}\r\n\r\nfunction parseResponse(resp) {\r\n    try {\r\n        resp = JSON.parse(resp);\r\n    } catch (e) {\r\n    }\r\n    return resp;\r\n}\r\n\r\nfunction isValidParam(obj) {\r\n    if (obj) {\r\n        for (var k in obj) {\r\n            return true;\r\n        }\r\n    }\r\n    return false;\r\n}\r\n\r\n\r\n// post请求\r\n// 格式化post 传递的数据\r\nfunction postDataFormat(obj){\r\n    if(typeof obj != \"object\") {\r\n        return obj;\r\n    }\r\n    // 支持有FormData的浏览器（Firefox 4+ , Safari 5+, Chrome和Android 3+版的Webkit）\r\n    if (typeof FormData == \"function\") {\r\n        var data = new FormData();\r\n        for(var attr in obj) {\r\n            data.append(attr,obj[attr]);\r\n        }\r\n        return data;\r\n    } else {\r\n        // 不支持FormData的浏览器的处理\r\n        var arr = [];\r\n        for(var attr in obj) {\r\n            var v = encodeURIComponent(attr) + \"=\" + encodeURIComponent(obj[attr]);\r\n            //var v = '' + attr + \"=\" + obj[attr];\r\n            arr.push(v);\r\n        }\r\n        return arr.join(\"&\");\r\n    }\r\n}\r\n\r\nfunction getHttpStateHandle(xhr, cb) {\r\n    return function() {\r\n        if (xhr.readyState == 4) {\r\n            var responseText = xhr.responseText;\r\n            if (xhr.status >= 200 && xhr.status < 300 && responseText) {\r\n                cb && cb(null, parseResponse(responseText), xhr.status);\r\n            } else if (xhr.status == 404 || !responseText) {\r\n                cb && cb(true, parseResponse(responseText), xhr.status);\r\n            } else {\r\n                cb && cb(true, parseResponse(responseText), xhr.status);\r\n            }\r\n        }\r\n    };\r\n}\r\n\r\nfunction getFileHttpStateHandle(xhr, cb) {\r\n    return function() {\r\n        if (xhr.readyState == 4) {\r\n            if (xhr.status >= 200 && xhr.status < 300) {\r\n                console.log(\"HHHHH\");\r\n                //cb && cb(null, xhr.response);\r\n            } else if (xhr.status == 404) {\r\n                cb && cb(true/*, responseText ? parseResponse(responseText) : undefined*/);\r\n            } else {\r\n                cb && cb(true);\r\n            }\r\n        }\r\n    };\r\n}\r\n\r\nhttp.get  = function(url, params, cb, timeOut) {\r\n    function callback(err, result, statusCode) {\r\n        handle && clearTimeout(handle);\r\n        handle = null;\r\n\r\n        cb && cb(err, result, statusCode);\r\n        cb = null;\r\n    }\r\n\r\n    timeOut = timeOut || 6000;\r\n    var handle = setTimeout(function () {\r\n        handle = null;\r\n        xhr.abort();\r\n        callback(true);\r\n    }, timeOut);\r\n\r\n    url = url + '?' + encodeParams(params);\r\n    var xhr = new XMLHttpRequest();\r\n    xhr.onreadystatechange = getHttpStateHandle(xhr, callback);\r\n    xhr.timeout = timeOut - 100;\r\n    xhr.ontimeout = function (e) {\r\n        cc.log(\"request timeout:\", url);\r\n        callback(true);\r\n    };\r\n\r\n    //cc.log(\"get -> [\" + url + \"]\");\r\n    xhr.open(\"GET\", url, true);\r\n    xhr.send();\r\n};\r\n\r\nhttp.getFile  = function(url, params, cb, timeOut) {\r\n    function callback(err, result) {\r\n        handle && clearTimeout(handle);\r\n        handle = null;\r\n\r\n        cb && cb(err, result);\r\n        cb = null;\r\n    }\r\n\r\n    timeOut = timeOut || 6000;\r\n    var handle = setTimeout(function () {\r\n        handle = null;\r\n        xhr.abort();\r\n        callback(true);\r\n    }, timeOut);\r\n\r\n    url = url + '?' + encodeParams(params);\r\n    var xhr = new XMLHttpRequest();\r\n    xhr.responseType = 'blob';\r\n    xhr.onreadystatechange = getFileHttpStateHandle(xhr, callback);\r\n    xhr.timeout = timeOut - 100;\r\n    xhr.ontimeout = function (e) {\r\n        cc.log(\"request timeout:\", url);\r\n        callback(true);\r\n    };\r\n\r\n    //cc.log(\"get -> [\" + url + \"]\");\r\n    xhr.open(\"GET\", url, true);\r\n    xhr.send();\r\n};\r\n\r\nhttp.post = function(url, params, body, cb, timeOut) {\r\n    function callback(err, result, statusCode) {\r\n        handle && clearTimeout(handle);\r\n        handle = null;\r\n\r\n        cb && cb(err, result, statusCode);\r\n        cb = null;\r\n    }\r\n\r\n    timeOut = timeOut || 6000;\r\n    var handle = setTimeout(function () {\r\n        handle = null;\r\n        xhr.abort();\r\n        callback(true);\r\n    }, timeOut);\r\n\r\n    isValidParam(params) && (url = url + '?' + encodeParams(params));\r\n    var xhr = new XMLHttpRequest();\r\n    xhr.onreadystatechange = getHttpStateHandle(xhr, callback);\r\n    xhr.timeout = timeOut - 100;\r\n    xhr.ontimeout = function (e) {\r\n        cc.log(\"request timeout:\", url);\r\n        callback(true);\r\n    };\r\n    xhr.open(\"POST\", url, true);\r\n    var data = JSON.stringify(body);\r\n    xhr.setRequestHeader(\"Content-Type\", \"application/json\");\r\n    xhr.send(data);\r\n    //cc.log(\"http post:\", url, JSON.stringify(body), data);\r\n};\r\n\r\nmodule.exports = (window.AF = window.AF || {}).http = http;"]}