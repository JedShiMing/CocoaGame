{"version":3,"sources":["../../../../../../assets/hall/ui/dialog/assets/hall/ui/dialog/LoginProgressDialog.js"],"names":["DialogBase","require","cc","Class","extends","properties","downloadProgress","default","type","ProgressBar","displayName","onLoad","prototype","call","node","getChildByName","y","winSize","height","regEvent","AF","Event","FILE_DOWNLOAD","onFileDownloaded","SHOW_LOGIN_PROGRESS_DIALOG","onShowLoginProgressDialog","QUERY_OBJECT","onQueryObject","onEnable","progress","percent","maxPercent","step","countUpdate","downloadState","workState","currentState","currentIndex","fileList","DIALOG_PARAMS","key","GameData","setMyObject","filename","url","state","length","console","log","downloadFile","Downloader","startDownloadFile","params","active","updateStep","split","updateStep2","EventDispatcher","emit","DOWNLOADDIAGLOG_ON_CLOSE","onMoreGamesClick","update","dt"],"mappings":"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","file":"LoginProgressDialog.js","sourceRoot":"../../../../../../assets/hall/ui/dialog","sourcesContent":["var DialogBase = require('AFDialogBase');\r\n\r\ncc.Class({\r\n    extends: DialogBase,\r\n\r\n    properties: {\r\n        downloadProgress: {\r\n            default: null,\r\n            type: cc.ProgressBar,\r\n            displayName: 'downloadProgress下载进度条'\r\n        },\r\n    },\r\n\r\n    // use this for initialization\r\n    onLoad: function () {\r\n        DialogBase.prototype.onLoad.call(this);\r\n        this.node.getChildByName('leftAnchor').y = 0 - cc.winSize.height / 2;\r\n        this.regEvent(AF.Event.FILE_DOWNLOAD, this.onFileDownloaded);\r\n        this.regEvent(AF.Event.SHOW_LOGIN_PROGRESS_DIALOG, this.onShowLoginProgressDialog);\r\n        this.regEvent(AF.Event.QUERY_OBJECT, this.onQueryObject);\r\n    },\r\n\r\n    onEnable: function () {\r\n        DialogBase.prototype.onEnable.call(this);\r\n        this.downloadProgress.progress = 0;\r\n        this.percent = 0;\r\n        this.maxPercent = 20;\r\n\r\n        this.step = 1;\r\n\r\n        this.countUpdate = 0;\r\n\r\n        //\r\n        this.downloadState = false;\r\n        this.workState = 0;\r\n\r\n        // 1 无下载任务 2 正在下载 3 下载完成 4 下载失败\r\n        this.currentState = 1;\r\n        this.currentIndex = -1;\r\n        this.fileList = AF.DIALOG_PARAMS();\r\n    },\r\n\r\n    onQueryObject: function (key) {\r\n\r\n        if (key == \"LoginProgressDialog\") {\r\n            AF.GameData.setMyObject(\"LoginProgressDialog\", true);\r\n        }\r\n\r\n    },\r\n\r\n    onFileDownloaded: function (filename, url, state) {\r\n\r\n        if (this.step !== 2) {\r\n            return;\r\n        }\r\n\r\n        if (this.currentIndex < 0 || this.currentIndex >= this.fileList.length) {\r\n            return;\r\n        }\r\n\r\n        if (filename !== this.fileList[this.currentIndex]) {\r\n            return;\r\n        }\r\n\r\n        if (state) {\r\n            console.log('file is downloaded succ ', filename);\r\n            this.currentState = 3;\r\n        } else {\r\n            console.log('file is downloaded fail ', filename);\r\n            this.currentState = 4;\r\n        }\r\n    },\r\n\r\n    downloadFile: function () {\r\n        AF.Downloader.startDownloadFile(this.fileList[this.currentIndex], false);\r\n    },\r\n\r\n    onShowLoginProgressDialog: function (step, percent, params) {\r\n\r\n        this.step = step;\r\n        this.maxPercent = percent;\r\n\r\n        if (this.step == 1) {\r\n            this.downloadProgress.node.active = true;\r\n            this.percent = 0;\r\n        } else if (this.step == 2) {\r\n            //\r\n            this.downloadState = false;\r\n            this.workState = 0;\r\n\r\n            // 1 无下载任务 2 正在下载 3 下载完成 4 下载失败\r\n            this.currentState = 1;\r\n            this.currentIndex = -1;\r\n            this.fileList = params;\r\n        }\r\n\r\n    },\r\n\r\n    updateStep: function () {\r\n\r\n        if (this.step == 4) {\r\n            return;\r\n        }\r\n\r\n        this.countUpdate += 1;\r\n\r\n        if (this.countUpdate > 4) {\r\n            this.countUpdate = 0;\r\n        }\r\n\r\n        var split = 0;\r\n\r\n        if (this.percent < this.maxPercent) {\r\n            split = this.maxPercent - this.percent;\r\n        }\r\n\r\n        if (split > 0) {\r\n            if (split < 5) {\r\n                if (this.countUpdate != 0) {\r\n                    return;\r\n                }\r\n            } else {\r\n                if (this.countUpdate == 1 || this.countUpdate == 3) {\r\n                    return\r\n                }\r\n            }\r\n        }\r\n\r\n        if (this.percent < this.maxPercent) {\r\n            this.percent += 2;\r\n            this.downloadProgress.progress = this.percent / 100;\r\n        }\r\n\r\n        if (this.percent >= 100) {\r\n            this.step = 4;\r\n            AF.GameData.setMyObject(\"LoginProgressDialogFinish\", true);\r\n            this.downloadProgress.node.active = false;\r\n        }\r\n    },\r\n\r\n    updateStep2: function () {\r\n\r\n        if (3 === this.workState) {\r\n            this.downloadState = true;\r\n            this.workState = 1;\r\n            return;\r\n        }\r\n\r\n        if (2 === this.workState) {\r\n            this.downloadState = false;\r\n            this.workState = 1;\r\n            return;\r\n        }\r\n\r\n        if (1 === this.workState) {\r\n            this.workState = -1;\r\n            //emit\r\n            AF.EventDispatcher.emit(AF.Event.DOWNLOADDIAGLOG_ON_CLOSE, this.downloadState);\r\n            return;\r\n        }\r\n\r\n        if (0 === this.workState) {\r\n            if (1 === this.currentState) {\r\n                if (this.currentIndex + 1 > this.fileList.length - 1) {\r\n                    this.workState = 3;\r\n                } else {\r\n                    this.currentIndex++;\r\n                    this.currentState = 2;\r\n                    this.downloadFile();\r\n                }\r\n            } else if (2 === this.currentState) {\r\n                //if()\r\n            } else if (3 === this.currentState) {\r\n                this.currentState = 1;\r\n            } else if (4 === this.currentState) {\r\n                //下载失败\r\n                this.workState = 2;\r\n            }\r\n        }\r\n\r\n\r\n    },\r\n\r\n    onMoreGamesClick: function () {\r\n    },\r\n\r\n    update: function (dt) {\r\n\r\n        this.updateStep();\r\n\r\n        if (this.step == 2) {\r\n            this.updateStep2();\r\n        }\r\n    }\r\n});\r\n"]}