const RANK_ITEM_HEIGHT = 160;

cc.Class({
    extends: cc.Component,

    properties: {
        bg: cc.Node,
        scrollView: cc.ScrollView,
        RankItemPre: cc.Prefab,
        tabBtn1: cc.Button,
        tabBtn2: cc.Button,
    },

    onLoad: function () {
        AF.ToastMessage.show("欢迎来到排行榜")
        // var self = this;
        //
        // self.tabIndex = 1;
        //
        // var top = 200;
        // var bottom = 125;
        //
        // var height = cc.winSize.height - top - bottom;
        //
        // self.scrollView.node.height = height;
        // self.scrollView.node.y = bottom - cc.winSize.height / 2;
        //
        // self.scrollView.content.height = height;
        // self.scrollView.content.y = 0;
        //
        // self.setPlayerData([]);
    },

    start: function () {
        var self = this;
        AF.util.getRankList((data) => {
            console.log('排行榜 data = ', data)
            if (data && data.length > 0) {
                self.setPlayerData(data)
            }
        })
        AF.EventDispatcher.emit(AF.Event.SCENE_LOADED);
    },

    update: function () {
        var self = this;
    },

    setPlayerData: function (players) {
        var self = this;

        self.players = players;

        var total_height = self.players.length * RANK_ITEM_HEIGHT;

        if (total_height < self.scrollView.node.height) {
            total_height = self.scrollView.node.height;
        }

        self.scrollView.content.height = total_height;
        self.scrollView.content.y = self.scrollView.node.height - self.scrollView.content.height;

        var myPlayer = null;
        var myRank;

        for (let i = 0; i < self.players.length; i++) {
            var item = cc.instantiate(self.RankItemPre);
            self.scrollView.content.addChild(item);

            console.log(self.players[i].nick);
            console.log(self.players[i].url);
            console.log(self.players[i].score);

            //selfFlag

            item.getComponent("RankItemPrefab").setPlayerInfo(i + 1, self.players[i].url, self.players[i].nick, self.players[i].score, false);

            item.x = self.scrollView.content.width / 2;
            item.y = total_height - i * RANK_ITEM_HEIGHT - RANK_ITEM_HEIGHT / 2;

            if (self.players[i].selfFlag) {
                myPlayer = self.players[i];
                myRank = i + 1;
            }
        }

        if (myPlayer) {
            var item = cc.instantiate(self.RankItemPre);
            self.bg.addChild(item);

            item.getComponent("RankItemPrefab").setPlayerInfo(myRank, myPlayer.url, myPlayer.nick, myPlayer.score, true);

            item.x = self.scrollView.node.x + self.scrollView.content.width / 2;
            item.y = self.scrollView.node.y + RANK_ITEM_HEIGHT/2;
        }
    },

    onBackButtonClick: function (event, custom) {
        AF.gotoScene("HallMainScene");
    },

    onTabButtonClick: function (event, custom) {
        //上传分数
        AF.util.upScore({
            score: Math.floor(Math.random() * 100),
            startTime: Date.now(),
            endTime: Date.now(),
        })

        AF.ToastMessage.show("全服排行榜，敬请期待");
        //AF.MessageBox.OK("title", "content");
    },

    refreshUI: function () {

    }
});
