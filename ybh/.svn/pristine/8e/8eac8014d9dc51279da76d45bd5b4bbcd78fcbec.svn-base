const RANK_ITEM_HEIGHT = 108;
const RANK_ITEM_PADDING = 14;
const list = [
    {
        avatarUrl: '',
        score: 100,
        nickname: 'jed',
    },
    {
        avatarUrl: '',
        score: 100,
        nickname: 'jed',
    },
    {
        avatarUrl: '',
        score: 100,
        nickname: 'jed',
    },
    {
        avatarUrl: '',
        score: 100,
        nickname: 'jed',
    },
    {
        avatarUrl: '',
        score: 100,
        nickname: 'jed',
    },
    {
        avatarUrl: '',
        score: 100,
        nickname: 'jed',
    },
    {
        avatarUrl: '',
        score: 100,
        nickname: 'jed',
    },
    {
        avatarUrl: '',
        score: 100,
        nickname: 'jed',
    },
    {
        avatarUrl: '',
        score: 100,
        nickname: 'jed',
    },
    {
        avatarUrl: '',
        score: 100,
        nickname: 'jed',
    },
    {
        avatarUrl: '',
        score: 100,
        nickname: 'jed',
    },
    {
        avatarUrl: '',
        score: 100,
        nickname: 'jed',
    },
    {
        avatarUrl: '',
        score: 100,
        nickname: 'jed',
    },
    {
        avatarUrl: '',
        score: 100,
        nickname: 'jed',
    }
    ]
cc.Class({
    extends: cc.Component,

    properties: {
        openData: cc.Node,
        scrollView: cc.ScrollView,
        RankItemPre: cc.Prefab,
        scrView: cc.Node,
    },

    start: function () {
        if (!this.isWxApp()) {
            return;
        }
        this.init();
        let self = this
        wx.onMessage(data => {
            if (data.cmd === 2) {
                console.log('监听到主域发来的消息,开始渲染排行榜')
                // this.requestDataFromServer()
            }
        });
    },

    init: function () {
        // this.players = [];
        this.players = list
        this.renderRank()
    },

    requestDataFromServer: function () {
        var self = this;
        //取出所有好友数据
        wx.getFriendCloudStorage({
            keyList: ["score"],
            success: res => {
                console.log("wx.getFriendCloudStorage success", res);
                self.players = [];

                for (let i = 0; i < res.data.length; i++) {
                    var data = res.data[i];

                    var obj = null;

                    for (let k = 0; k < data.KVDataList.length; k++) {
                        var kvData = data.KVDataList[k];

                        if (kvData.key === "score") {
                            obj = JSON.parse(kvData.value);
                            break;
                        }

                        if (obj) {
                            break;
                        }
                    }

                    if (obj) {
                        var player = {};
                        player.score = obj.score || 0;
                        player.startTime = obj.startTime || 0;
                        player.endTime = obj.endTime || 0;
                        player.openid = data.openid;
                        player.nickname = data.nickname;
                        player.avatarUrl = data.avatarUrl;
                        self.players.push(player);
                    }
                }
                if (self.players.length > 0) {
                    console.log('有好友 -- ', self.players);
                    self.renderRank()
                } else {
                    console.log('没有好友')
                }
            },
            fail: res => {
                console.log("wx.getFriendCloudStorage fail", res);
            },
        });
    },

    renderRank() {
        let self = this;
        let friends = self.players;
        let total_height = friends.length * RANK_ITEM_HEIGHT + RANK_ITEM_PADDING * (friends.length - 1);

        if (total_height < self.scrollView.node.height) {
            total_height = self.scrollView.node.height;
        }
        let myPlayer = null;
        let myRank;

        for (let i = 0; i < friends.length; i++) {
            let item = cc.instantiate(self.RankItemPre);
            self.scrollView.content.addChild(item);

            item.getComponent("RankItemPrefab").setPlayerInfo(i + 1, friends[i].avatarUrl, friends[i].nickname, friends[i].score, false);

            item.x = self.scrollView.content.width / 2;
            if (friends[i].selfFlag) {
                self.startY = i * (RANK_ITEM_PADDING + RANK_ITEM_HEIGHT)
                myPlayer = friends[i];
                myRank = i + 1;
            }
        }

        if (myPlayer) {
            self.selfItem = cc.instantiate(self.RankItemPre);
            self.bg.addChild(self.selfItem);

            self.selfItem.getComponent("RankItemPrefab").setPlayerInfo(myRank, myPlayer.avatarUrl, myPlayer.nickname, myPlayer.score, true);
            self.selfItem.x = 0;
            self.selfItem.y = -(self.scrollView.node.height / 2);
            self.selfItem.active = self.scrView.height < self.startY
        }
    },

    isWxApp: function () {
        return 'undefined' !== typeof (wx);
    },
});
