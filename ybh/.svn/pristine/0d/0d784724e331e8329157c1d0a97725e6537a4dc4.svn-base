import BalancePassedView from './Script/BalancePassedView'
import FriendPassedView from './Script/FriendPassedView'
import Util from './Script/Util'

const RANK_ITEM_HEIGHT = 108;
const RANK_ITEM_PADDING = 14;
const PADDING_BOTTOM_H = 50;
cc.Class({
    extends: cc.Component,

    properties: {
        ranks: cc.Node,
        RankItemPre: cc.Prefab,
        Balance: cc.Node,
        Friend: cc.Node
    },

    start() {
        if (!this.isWxApp()) {
            return;
        }
        let self = this;
        wx.onMessage(data => {
            console.log('收到主域消息', data);
            if (!data.cmd) {
                self.ranks.active = false
                self.Balance.active = false
                self.Friend.active = false
            } else if (data.cmd === 2) { // 排行榜
                console.log('显示排行榜');
                self.ranks.active = true
                self.Balance.active = false
                self.Friend.active = false
                self.requestDataFromServer();
            } else if (data.cmd === 3) { // 已通关好友, 右上角
                console.log('显示右上角');
                self.ranks.active = false
                self.Balance.active = false
                self.Friend.active = true
                self.showFriendPass(data.data)
            } else if (data.cmd === 4) { // 已通关好友, 中间
                console.log('显示中间');
                self.ranks.active = false
                self.Balance.active = true
                self.Friend.active = false
                self.showBalancePass(data.data)
            }
        })
    },

    requestDataFromServer: function () {
        var self = this;
        Util.getWXFriendRanks().then(list => {
            if (list) self.renderRank(list)
        })
    },

    renderRank(players) {
        let self = this;
        let friends = players;
        console.log('ranks = ', self.ranks)
        let _content = self.ranks.getChildByName('view').getChildByName('content')
        for (let i = 0; i < friends.length; i++) {
            let item = cc.instantiate(self.RankItemPre);
            _content.addChild(item);
            item.getComponent("RankItemPrefab").setPlayerInfo(i + 1, friends[i].avatarUrl, friends[i].nickname, friends[i].score, false);
        }
    },
    isWxApp: function () {
        return 'undefined' !== typeof (wx);
    },


    showFriendPass(data) {
        this.Friend.active = true
        console.log('Friend = ', this.Friend)
        this.Friend.getComponent(FriendPassedView).updatePoint(data.pointId)

    },
    showBalancePass(info) {
        this.Balance.active = true
        console.log('Balance = ', this.Balance)
        this.Balance.getComponent(BalancePassedView).updatePoint(info)
    },
});
